/**
 * Delta-T calculation: UT → TT (Terrestrial Time) correction
 *
 * Ported from swephlib.c (Swiss Ephemeris)
 * Authors: Dieter Koch and Alois Treindl
 *
 * Uses the Stephenson/Morrison/Hohenkerk 2016 model for epochs before 1955
 * and Astronomical Almanac / IERS tabulated data for 1620+.
 *
 * AGPL-licensed — see Swiss Ephemeris license terms.
 */

const J2000 = 2451545.0
const SE_TIDAL_26 = -26.0
const SE_TIDAL_STEPHENSON_2016 = -25.85
const TABSTART = 1620
const TABEND = 2028

/** Tabulated Delta-T values (hundredths of a second), 1620–2028 */
const dt: number[] = [
  // 1620–1659
  124.00, 119.00, 115.00, 110.00, 106.00, 102.00, 98.00, 95.00, 91.00, 88.00,
  85.00, 82.00, 79.00, 77.00, 74.00, 72.00, 70.00, 67.00, 65.00, 63.00,
  62.00, 60.00, 58.00, 57.00, 55.00, 54.00, 53.00, 51.00, 50.00, 49.00,
  48.00, 47.00, 46.00, 45.00, 44.00, 43.00, 42.00, 41.00, 40.00, 38.00,
  // 1660–1699
  37.00, 36.00, 35.00, 34.00, 33.00, 32.00, 31.00, 30.00, 28.00, 27.00,
  26.00, 25.00, 24.00, 23.00, 22.00, 21.00, 20.00, 19.00, 18.00, 17.00,
  16.00, 15.00, 14.00, 14.00, 13.00, 12.00, 12.00, 11.00, 11.00, 10.00,
  10.00, 10.00, 9.00, 9.00, 9.00, 9.00, 9.00, 9.00, 9.00, 9.00,
  // 1700–1739
  9.00, 9.00, 9.00, 9.00, 9.00, 9.00, 9.00, 9.00, 10.00, 10.00,
  10.00, 10.00, 10.00, 10.00, 10.00, 10.00, 10.00, 11.00, 11.00, 11.00,
  11.00, 11.00, 11.00, 11.00, 11.00, 11.00, 11.00, 11.00, 11.00, 11.00,
  11.00, 11.00, 11.00, 11.00, 12.00, 12.00, 12.00, 12.00, 12.00, 12.00,
  // 1740–1779
  12.00, 12.00, 12.00, 12.00, 13.00, 13.00, 13.00, 13.00, 13.00, 13.00,
  13.00, 14.00, 14.00, 14.00, 14.00, 14.00, 14.00, 14.00, 15.00, 15.00,
  15.00, 15.00, 15.00, 15.00, 15.00, 16.00, 16.00, 16.00, 16.00, 16.00,
  16.00, 16.00, 16.00, 16.00, 16.00, 17.00, 17.00, 17.00, 17.00, 17.00,
  // 1780–1799
  17.00, 17.00, 17.00, 17.00, 17.00, 17.00, 17.00, 17.00, 17.00, 17.00,
  17.00, 17.00, 16.00, 16.00, 16.00, 16.00, 15.00, 15.00, 14.00, 14.00,
  // 1800–1819
  13.70, 13.40, 13.10, 12.90, 12.70, 12.60, 12.50, 12.50, 12.50, 12.50,
  12.50, 12.50, 12.50, 12.50, 12.50, 12.50, 12.50, 12.40, 12.30, 12.20,
  // 1820–1859
  12.00, 11.70, 11.40, 11.10, 10.60, 10.20, 9.60, 9.10, 8.60, 8.00,
  7.50, 7.00, 6.60, 6.30, 6.00, 5.80, 5.70, 5.60, 5.60, 5.60,
  5.70, 5.80, 5.90, 6.10, 6.20, 6.30, 6.50, 6.60, 6.80, 6.90,
  7.10, 7.20, 7.30, 7.40, 7.50, 7.60, 7.70, 7.70, 7.80, 7.80,
  // 1860–1899
  7.88, 7.82, 7.54, 6.97, 6.40, 6.02, 5.41, 4.10, 2.92, 1.82,
  1.61, .10, -1.02, -1.28, -2.69, -3.24, -3.64, -4.54, -4.71, -5.11,
  -5.40, -5.42, -5.20, -5.46, -5.46, -5.79, -5.63, -5.64, -5.80, -5.66,
  -5.87, -6.01, -6.19, -6.64, -6.44, -6.47, -6.09, -5.76, -4.66, -3.74,
  // 1900–1939
  -2.72, -1.54, -.02, 1.24, 2.64, 3.86, 5.37, 6.14, 7.75, 9.13,
  10.46, 11.53, 13.36, 14.65, 16.01, 17.20, 18.24, 19.06, 20.25, 20.95,
  21.16, 22.25, 22.41, 23.03, 23.49, 23.62, 23.86, 24.49, 24.34, 24.08,
  24.02, 24.00, 23.87, 23.95, 23.86, 23.93, 23.73, 23.92, 23.96, 24.02,
  // 1940–1949
  24.33, 24.83, 25.30, 25.70, 26.24, 26.77, 27.28, 27.78, 28.25, 28.71,
  // 1950–1959
  29.15, 29.57, 29.97, 30.36, 30.72, 31.07, 31.35, 31.68, 32.18, 32.68,
  // 1960–1969
  33.15, 33.59, 34.00, 34.47, 35.03, 35.73, 36.54, 37.43, 38.29, 39.20,
  // 1970–1979
  40.18, 41.17, 42.23, 43.37, 44.4841, 45.4761, 46.4567, 47.5214, 48.5344, 49.5862,
  // 1980–1989
  50.5387, 51.3808, 52.1668, 52.9565, 53.7882, 54.3427, 54.8713, 55.3222, 55.8197, 56.3000,
  // 1990–1999
  56.8553, 57.5653, 58.3092, 59.1218, 59.9845, 60.7854, 61.6287, 62.2951, 62.9659, 63.4673,
  // 2000–2009
  63.8285, 64.0908, 64.2998, 64.4734, 64.5736, 64.6876, 64.8452, 65.1464, 65.4574, 65.7768,
  // 2010–2019
  66.0699, 66.3246, 66.6030, 66.9069, 67.2810, 67.6439, 68.1024, 68.5927, 68.9676, 69.2202,
  // 2020–2028
  69.3612, 69.3593, 69.2945, 69.1833, 69.10, 69.00, 68.90, 68.80, 68.80,
]

/** Spline coefficients from Stephenson/Morrison/Hohenkerk 2016 */
const dtcf16: number[][] = [
  [1458085.5, 1867156.5, 20550.593, -21268.478, 11863.418, -4541.129],
  [1867156.5, 2086302.5, 6604.404, -5981.266, -505.093, 1349.609],
  [2086302.5, 2268923.5, 1467.654, -2452.187, 2460.927, -1183.759],
  [2268923.5, 2305447.5, 292.635, -216.322, -43.614, 56.681],
  [2305447.5, 2323710.5, 89.380, -66.754, 31.607, -10.497],
  [2323710.5, 2349276.5, 43.736, -49.043, 0.227, 15.811],
  [2349276.5, 2378496.5, 10.730, -1.321, 62.250, -52.946],
  [2378496.5, 2382148.5, 18.714, -4.457, -1.509, 2.507],
  [2382148.5, 2385800.5, 15.255, 0.046, 6.012, -4.634],
  [2385800.5, 2389453.5, 16.679, -1.831, -7.889, 3.799],
  [2389453.5, 2393105.5, 10.758, -6.211, 3.509, -0.388],
  [2393105.5, 2396758.5, 7.668, -0.357, 2.345, -0.338],
  [2396758.5, 2398584.5, 9.317, 1.659, 0.332, -0.932],
  [2398584.5, 2400410.5, 10.376, -0.472, -2.463, 1.596],
  [2400410.5, 2402237.5, 9.038, -0.610, 2.325, -2.497],
  [2402237.5, 2404063.5, 8.256, -3.450, -5.166, 2.729],
  [2404063.5, 2405889.5, 2.369, -5.596, 3.020, -0.919],
  [2405889.5, 2407715.5, -1.126, -2.312, 0.264, -0.037],
  [2407715.5, 2409542.5, -3.211, -1.894, 0.154, 0.562],
  [2409542.5, 2411368.5, -4.388, 0.101, 1.841, -1.438],
  [2411368.5, 2413194.5, -3.884, -0.531, -2.473, 1.870],
  [2413194.5, 2415020.5, -5.017, 0.134, 3.138, -0.232],
  [2415020.5, 2416846.5, -1.977, 5.715, 2.443, -1.257],
  [2416846.5, 2418672.5, 4.923, 6.828, -1.329, 0.720],
  [2418672.5, 2420498.5, 11.142, 6.330, 0.831, -0.825],
  [2420498.5, 2422324.5, 17.479, 5.518, -1.643, 0.262],
  [2422324.5, 2424151.5, 21.617, 3.020, -0.856, 0.008],
  [2424151.5, 2425977.5, 23.789, 1.333, -0.831, 0.127],
  [2425977.5, 2427803.5, 24.418, 0.052, -0.449, 0.142],
  [2427803.5, 2429629.5, 24.164, -0.419, -0.022, 0.702],
  [2429629.5, 2431456.5, 24.426, 1.645, 2.086, -1.106],
  [2431456.5, 2433282.5, 27.050, 2.499, -1.232, 0.614],
  [2433282.5, 2434378.5, 28.932, 1.127, 0.220, -0.277],
  [2434378.5, 2435473.5, 30.002, 0.737, -0.610, 0.631],
  [2435473.5, 2436569.5, 30.760, 1.409, 1.282, -0.799],
  [2435473.5 + 1096, 2437665.5, 32.652, 1.577, -1.115, 0.507],
  [2437665.5, 2438761.5, 33.621, 0.868, 0.406, 0.199],
  [2438761.5, 2439856.5, 35.093, 2.275, 1.002, -0.414],
  [2439856.5, 2440952.5, 37.956, 3.035, -0.242, 0.202],
  [2440952.5, 2442048.5, 40.951, 3.157, 0.364, -0.229],
  [2442048.5, 2443144.5, 44.244, 3.198, -0.323, 0.172],
  [2443144.5, 2444239.5, 47.291, 3.069, 0.193, -0.192],
  [2444239.5, 2445335.5, 50.361, 2.878, -0.384, 0.081],
  [2445335.5, 2446431.5, 52.936, 2.354, -0.140, -0.166],
  [2446431.5, 2447527.5, 54.984, 1.577, -0.637, 0.448],
  [2447527.5, 2448622.5, 56.373, 1.649, 0.709, -0.277],
  [2448622.5, 2449718.5, 58.453, 2.235, -0.122, 0.111],
  [2449718.5, 2450814.5, 60.677, 2.324, 0.212, -0.315],
  [2450814.5, 2451910.5, 62.899, 1.804, -0.732, 0.112],
  [2451910.5, 2453005.5, 64.082, 0.675, -0.396, 0.193],
  [2453005.5, 2454101.5, 64.555, 0.463, 0.184, -0.008],
  [2454101.5, 2455197.5, 65.194, 0.809, 0.161, -0.101],
  [2455197.5, 2456293.5, 66.063, 0.828, -0.142, 0.168],
  [2456293.5, 2457388.5, 66.917, 1.046, 0.360, -0.282],
]

function adjustForTidacc(
  ans: number, Y: number, tidAcc: number, tidAcc0: number, adjustAfter1955: boolean,
): number {
  if (Y < 1955.0 || adjustAfter1955) {
    const B = Y - 1955.0
    ans += -0.000091 * (tidAcc - tidAcc0) * B * B
  }
  return ans
}

/** Stephenson/Morrison/Hohenkerk 2016 spline model (for epochs before 1955) */
function deltatStephenson2016(tjd: number, tidAcc: number): number {
  const Ygreg = 2000.0 + (tjd - J2000) / 365.2425
  let dt: number
  let irec = -1
  for (let i = 0; i < dtcf16.length; i++) {
    if (tjd < dtcf16[i][0]) break
    if (tjd < dtcf16[i][1]) {
      irec = i
      break
    }
  }
  if (irec >= 0) {
    const t = (tjd - dtcf16[irec][0]) / (dtcf16[irec][1] - dtcf16[irec][0])
    dt = dtcf16[irec][2] + dtcf16[irec][3] * t + dtcf16[irec][4] * t * t + dtcf16[irec][5] * t * t * t
  } else if (Ygreg < -720) {
    const t = (Ygreg - 1825) / 100.0
    dt = -320 + 32.5 * t * t
    dt -= 179.7337208
  } else {
    const t = (Ygreg - 1825) / 100.0
    dt = -320 + 32.5 * t * t
    dt += 269.4790417
  }
  dt = adjustForTidacc(dt, Ygreg, tidAcc, SE_TIDAL_STEPHENSON_2016, true)
  return dt / 86400.0
}

/**
 * Bessel interpolation of tabulated Delta-T (1620 onwards).
 * Values from Astronomical Almanac K8-K9 and IERS.
 */
function deltatAA(tjd: number, tidAcc: number): number {
  const tabsiz = dt.length
  const tabend = TABSTART + tabsiz - 1
  const Y = 2000.0 + (tjd - 2451544.5) / 365.25
  const d = new Array<number>(6).fill(0)

  if (Y <= tabend) {
    let p = Math.floor(Y)
    const iy = Math.trunc(p - TABSTART)
    let ans = dt[iy]
    let k = iy + 1
    if (k >= tabsiz) {
      return adjustForTidacc(ans, Y, tidAcc, SE_TIDAL_26, false) / 86400.0
    }
    p = Y - p
    ans += p * (dt[k] - dt[iy])
    if (iy - 1 < 0 || iy + 2 >= tabsiz) {
      return adjustForTidacc(ans, Y, tidAcc, SE_TIDAL_26, false) / 86400.0
    }
    k = iy - 2
    for (let i = 0; i < 5; i++) {
      if (k < 0 || k + 1 >= tabsiz) d[i] = 0
      else d[i] = dt[k + 1] - dt[k]
      k += 1
    }
    for (let i = 0; i < 4; i++) d[i] = d[i + 1] - d[i]
    let B = 0.25 * p * (p - 1.0)
    ans += B * (d[1] + d[2])
    if (iy + 2 >= tabsiz) {
      return adjustForTidacc(ans, Y, tidAcc, SE_TIDAL_26, false) / 86400.0
    }
    for (let i = 0; i < 3; i++) d[i] = d[i + 1] - d[i]
    B = 2.0 * B / 3.0
    ans += (p - 0.5) * B * d[1]
    if (iy - 2 < 0 || iy + 3 > tabsiz) {
      return adjustForTidacc(ans, Y, tidAcc, SE_TIDAL_26, false) / 86400.0
    }
    for (let i = 0; i < 2; i++) d[i] = d[i + 1] - d[i]
    B = 0.125 * B * (p + 1.0) * (p - 2.0)
    ans += B * (d[0] + d[1])
    return adjustForTidacc(ans, Y, tidAcc, SE_TIDAL_26, false) / 86400.0
  }

  // Future extrapolation: Stephenson 2016 polynomial
  const B = Y - 2000
  let ans: number
  if (Y < 2500) {
    ans = B * B * B * 121.0 / 30000000.0 + B * B / 1250.0 + B * 521.0 / 3000.0 + 64.0
    const B2 = tabend - 2000
    const ans2 = B2 * B2 * B2 * 121.0 / 30000000.0 + B2 * B2 / 1250.0 + B2 * 521.0 / 3000.0 + 64.0
    if (Y <= tabend + 100) {
      const ans3 = dt[tabsiz - 1]
      const dd = ans2 - ans3
      ans += dd * (Y - (tabend + 100)) * 0.01
    }
  } else {
    const Bc = 0.01 * (Y - 2000)
    ans = Bc * Bc * 32.5 + 42.5
  }
  return ans / 86400.0
}

/**
 * Calculate Delta-T (ΔT = TT − UT) in days.
 *
 * For the Moshier ephemeris, the tidal acceleration is fixed at -26.0"/cy².
 *
 * @param tjd Julian day number in UT
 * @returns ΔT in days (add to UT JD to get TT JD)
 */
export function deltaT(tjd: number): number {
  const tidAcc = SE_TIDAL_26

  // Stephenson/Morrison/Hohenkerk 2016 for epochs before 1955
  // JD 2435108.5 = 1 Jan 1955
  if (tjd < 2435108.5) {
    let d = deltatStephenson2016(tjd, tidAcc)
    // Smooth transition over 1000 days before 1955
    if (tjd >= 2434108.5) {
      d += (1.0 - (2435108.5 - tjd) / 1000.0) * 0.6610218 / 86400.0
    }
    return d
  }

  // AA table interpolation for 1620+
  const Y = 2000.0 + (tjd - 2451544.5) / 365.25
  if (Y >= TABSTART) {
    return deltatAA(tjd, tidAcc)
  }

  return 0
}
